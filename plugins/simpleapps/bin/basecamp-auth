#!/usr/bin/env python3
# /// script
# requires-python = ">=3.10"
# dependencies = []
# ///
"""
Basecamp 2 OAuth setup script.
Authorizes with Basecamp 2 and saves credentials to ~/.simpleapps/basecamp.json

Usage: uv run basecamp-auth
"""

import http.server
import json
import os
import sys
import threading
import urllib.parse
import urllib.request
import webbrowser

CLIENT_ID = "0ff91e9b1365da1686eb1ac639ae30cc915f10f9"
CLIENT_SECRET = "7e1e63759ec32a3f00813d32b93d339116d0ff62"
REDIRECT_URI = "http://localhost:9292/callback"
AUTH_URL = "https://launchpad.37signals.com/authorization/new"
TOKEN_URL = "https://launchpad.37signals.com/authorization/token"

CREDS_DIR = os.path.expanduser("~/.simpleapps")
CREDS_FILE = os.path.join(CREDS_DIR, "basecamp.json")

auth_code = None
server_ready = threading.Event()


class CallbackHandler(http.server.BaseHTTPRequestHandler):
    def do_GET(self):
        global auth_code
        parsed = urllib.parse.urlparse(self.path)
        params = urllib.parse.parse_qs(parsed.query)

        if "code" in params:
            auth_code = params["code"][0]
            self.send_response(200)
            self.send_header("Content-Type", "text/html")
            self.end_headers()
            self.wfile.write(b"<h1>Authorized!</h1><p>You can close this tab.</p>")
        else:
            self.send_response(400)
            self.send_header("Content-Type", "text/html")
            self.end_headers()
            self.wfile.write(b"<h1>Error</h1><p>No authorization code received.</p>")

        threading.Thread(target=self.server.shutdown).start()

    def log_message(self, format, *args):
        pass  # Suppress request logging


def exchange_code(code: str) -> dict:
    data = urllib.parse.urlencode({
        "type": "web_server",
        "client_id": CLIENT_ID,
        "client_secret": CLIENT_SECRET,
        "redirect_uri": REDIRECT_URI,
        "code": code,
    }).encode()

    req = urllib.request.Request(TOKEN_URL, data=data, method="POST")
    req.add_header("Content-Type", "application/x-www-form-urlencoded")

    with urllib.request.urlopen(req) as resp:
        return json.loads(resp.read())


SIMPLEAPPS_ACCOUNT_ID = "2805226"


def get_account_id(access_token: str) -> str:
    """Verify the user has access to the SimpleApps Basecamp account."""
    req = urllib.request.Request("https://launchpad.37signals.com/authorization.json")
    req.add_header("Authorization", f"Bearer {access_token}")
    req.add_header("User-Agent", "SimpleApps Basecamp MCP (stuart@simpleapps.com)")

    try:
        with urllib.request.urlopen(req) as resp:
            data = json.loads(resp.read())

        for account in data.get("accounts", []):
            if str(account.get("id")) == SIMPLEAPPS_ACCOUNT_ID:
                print(f"Found SimpleApps account: {account['name']}")
                return SIMPLEAPPS_ACCOUNT_ID

        print("Error: You do not have access to the SimpleApps Basecamp account.")
        sys.exit(1)

    except urllib.error.HTTPError:
        pass  # Fall through to manual entry

    return ""


def save_credentials(token_data: dict, account_id: str):
    os.makedirs(CREDS_DIR, mode=0o700, exist_ok=True)

    creds = {
        "account_id": account_id,
        "access_token": token_data["access_token"],
        "refresh_token": token_data["refresh_token"],
    }

    with open(CREDS_FILE, "w") as f:
        json.dump(creds, f, indent=2)

    os.chmod(CREDS_FILE, 0o600)
    print(f"Credentials saved to {CREDS_FILE}")


def main():
    print("Basecamp 2 OAuth Setup")
    print("=" * 40)

    # Check for existing credentials
    if os.path.exists(CREDS_FILE):
        resp = input(f"\n{CREDS_FILE} already exists. Overwrite? [y/N] ")
        if resp.lower() != "y":
            print("Aborted.")
            sys.exit(0)

    # Start local server
    server = http.server.HTTPServer(("localhost", 9292), CallbackHandler)
    server_thread = threading.Thread(target=server.serve_forever)
    server_thread.start()

    # Open browser for authorization
    auth_params = urllib.parse.urlencode({
        "type": "web_server",
        "client_id": CLIENT_ID,
        "redirect_uri": REDIRECT_URI,
    })
    auth_url = f"{AUTH_URL}?{auth_params}"

    print(f"\nOpening browser for authorization...")
    print(f"If it doesn't open, visit: {auth_url}\n")
    webbrowser.open(auth_url)

    # Wait for callback
    server_thread.join(timeout=120)

    if not auth_code:
        print("Error: No authorization code received. Timed out after 120 seconds.")
        sys.exit(1)

    print("Authorization code received. Exchanging for token...")

    # Exchange code for token
    token_data = exchange_code(auth_code)

    # Get account ID
    print("Fetching account info...")
    account_id = get_account_id(token_data["access_token"])

    if not account_id:
        print("Warning: Could not auto-detect Basecamp 2 account ID.")
        account_id = input("Enter your Basecamp 2 account ID: ")

    # Save credentials
    save_credentials(token_data, account_id)

    print(f"\nDone! Account ID: {account_id}")
    print("You can now use the Basecamp MCP server.")


if __name__ == "__main__":
    main()
